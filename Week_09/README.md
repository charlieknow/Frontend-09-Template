## 学习笔记 | 浏览器工作原理
### HTML解析
#### 1.parse模块的文件拆分
* 为了方便文件管理， 把parser单独拆到文件中
* parseHTML接受HTML文本作为参数返回DON树
#### 2.用FSM实现HTML的分析
* 在HTML的标准中，已经规定了HTML的状态。[html tokenization](https://html.spec.whatwg.org/multipage/)
#### 3.解析标签（Tag）
* 主要标签有： 开始标签、结束标签、自封闭标签
* 这一步暂时忽略属性
#### 4.创建元素
* 在状态机中，除了状态迁移，还要加入业务逻辑
* 我们在标签结束状态提交标签token
#### 5.处理属性
* 属性分为单引号 双引号 无引号三种写法，因此需要比较多的状态
* 处理方式和标签类似
#### 6.用token构建DOM树
* 从标签构建DOM树的基本技巧就是使用栈
* 遇到开始标签创建元素入栈，遇到结束标签出栈
* 自封闭节点可视为入栈后立即出栈
* 任何元素的父元素是他入栈前的栈顶
#### 7.将文本节点加到DOM树
* 文本节点与自封闭标签类似处理类似
* 多个文本节点需要合并

---
### CSS计算
#### 收集CSS
* 遇到style标签时，把CSS规则保存起来
* 调用CSS Parser来分析CSS规则
* 必须研究css库分析的CSS规则格式
#### 添加调用
* 创建一个元素后，立即计算CSS
* 如果遇到写在body里的style标签，我们需要重新计算CSS的
#### 获取父元素序列
* 必须知道元素的所有父元素才能判断元素与规则是否匹配
* 从上一步骤的stack，可以获取本元素的所有父元素
* 首先获取的是当前元素，所以我们获得和计算父元素匹配的顺序是从内而外的
#### 选择器与元素匹配
* 选择器也要从当前元素向外排列
* 复杂选择器拆成针对单个元素的选择器，用循环匹配父元素队列
#### 计算选择器与元素是否匹配
* 根据选择器的类型和元素属性，计算是否与当前元素匹配
* 实际浏览器中会处理复合选择器
#### 生成computedStyle属性
* 一旦选择器与元素匹配，就应用到选择器的元素上，形成computedStyle
#### Specificity计算逻辑
* CSS规则根据Specificity和后来优先规则覆盖
* Specificity是一个四元组，越左边权重越高
* 一个CSS规则的Specificity根据包含的简单选择器相加而成